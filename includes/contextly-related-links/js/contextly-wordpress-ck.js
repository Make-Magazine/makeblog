/**
 * Main script or build Contextly widget, using REST api.
 */Contextly=Contextly||{};Contextly.Errors={ERROR_FORBIDDEN:403,ERROR_SUSPENDED:408};Contextly.WidgetType={SNIPPET:"snippet",SIDEBAR:"sidebar",AUTO_SIDEBAR:"auto-sidebar"};Contextly.LinkType={PREVIOUS:"previous",RECENT:"recent",WEB:"web",INTERESTING:"interesting",CUSTOM:"custom",PROMO:"sticky"};Contextly.Singleton=Contextly.createClass({statics:{construct:function(){this._instance=null},getInstance:function(){this._instance===null&&(this._instance=new this);return this._instance}}});Contextly.Loader=Contextly.createClass({extend:Contextly.Singleton,isCallAvailable:function(){return Contextly.Settings.getInstance().isReadyToLoad()},getLastResponse:function(){return this.response},isWidgetHasLinks:function(){var e=!1,t=this.getLastResponse();if(t&&t.entry){t.entry.snippets&&(e=this.isEntryWidgetsHasLinks(t.entry.snippets));!e&&t.entry.sidebars&&(e=this.isEntryWidgetsHasLinks(t.entry.sidebars));!e&&t.entry.auto_sidebars&&(e=this.isEntryWidgetsHasLinks(t.entry.auto_sidebars))}return e},isEntryWidgetsHasLinks:function(e){for(var t=0;t<e.length;t++)if(e[t].links)return!0;return!1},load:function(){if(!this.isCallAvailable())return;var e=this;Contextly.RESTClient.getInstance().call("pagewidgets","get",{},function(t){e.response=t;var n=new Contextly.PageView(t);n.display()})},trackPageEvent:function(e,t,n){if(!this.isCallAvailable())return;var r={post_id:Contextly.Settings.getInstance().getPageId(),setting_id:e,event_name:t,event_key:n,event_date:new Date};Contextly.RESTClient.getInstance().call("siteevents","put",r,function(e){})}});Contextly.PageView=Contextly.createClass({construct:function(e){this.entry=null;this.error=null;e.entry?this.entry=e.entry:e.error&&(this.error=e)},isError:function(){return this.error!=null},display:function(){if(this.isError()&&Contextly.Settings.getInstance().isAdmin()){var e="",t="admin.php?page=contextly_options&tab=contextly_options_api";this.error.error?this.error.error_code==Contextly.Errors.ERROR_FORBIDDEN?e=this.error.error+" Please check your API settings on the Contextly plugin <a href='admin.php?page=contextly_options&tab=contextly_options_api'>Settings</a> page.":this.error.error_code==Contextly.Errors.ERROR_SUSPENDED?e="Your account has been suspended. If this is an error, please contact us via <a href='http://contextly.com/contact-us/'>support@contextly.com</a>.":e="Please check your API settings on the Contextly plugin <a href='admin.php?page=contextly_options&tab=contextly_options_api'>Settings</a> page.":e="Sorry, something seems to be broken. Please contact us via <a href='http://contextly.com/contact-us/'>support@contextly.com</a>.";var n=new Contextly.SnippetWidgetFormatter;n.displayText(e);Contextly.PopupHelper.getInstance().initWithUrl(t)}else if(this.entry){Contextly.PopupHelper.getInstance().initWithWidget(this.entry);this.entry.snippets&&this.entry.snippets.length>0&&this.displayWidgets(this.entry.snippets);this.entry.sidebars&&this.entry.sidebars.length>0&&this.displayWidgets(this.entry.sidebars);this.entry.auto_sidebars&&this.entry.auto_sidebars.length>0&&this.displayWidgets(this.entry.auto_sidebars);Contextly.Settings.getInstance().isAdmin()||this.checkPost()}Contextly.Settings.getInstance().isAdmin()&&this.attachPublishConfirmation()},attachPublishConfirmation:function(){jQuery("#publish").click(function(){var e=Contextly.Settings.getInstance().getWPSettings();if(e.publish_confirmation){if(Contextly.Loader.getInstance().isWidgetHasLinks())return!0;Contextly.PopupHelper.getInstance().showPublishConfirmation();return!1}return!0})},checkPost:function(){var e=!1;if(!this.entry.created_date)e=!0;else{var t=Contextly.Utils.getInstance().isPostNeedsToBeUpdated(this.entry.created_date,Contextly.Settings.getInstance().getPostCreatedDate()),n=Contextly.Utils.getInstance().isPostNeedsToBeUpdated(this.entry.modified_date,Contextly.Settings.getInstance().getPostModifiedDate());if(t||n)e=!0}e&&this.updatePost()},updatePost:function(){var e={action:"contextly_publish_post",page_id:Contextly.Settings.getInstance().getPageId(),contextly_nonce:Contextly.Settings.getInstance().getAjaxNonce()};jQuery.ajax({url:Contextly.ajax_url,type:"post",dataType:"json",data:e,success:function(){}})},displayWidgets:function(e){if(e&&e.length)for(var t=0;t<e.length;t++){var n=Contextly.WidgetFactory.getInstance().getWidget(e[t]);n&&n.display()}}});Contextly.WidgetFactory=Contextly.createClass({extend:Contextly.Singleton,getWidget:function(e){return e?e.type==Contextly.WidgetType.SIDEBAR?new Contextly.SidebarWidget(e):e.type==Contextly.WidgetType.AUTO_SIDEBAR?new Contextly.AutoSidebarWidget(e):new Contextly.SnippetWidget(e):null}});Contextly.Widget=Contextly.createClass({construct:function(e){this.widget=e},getWidgetFormatter:function(){return null},display:function(){var e=this.getWidgetFormatter();e&&e.display&&e.display()}});Contextly.SnippetWidget=Contextly.createClass({extend:Contextly.Widget,getWidgetFormatter:function(){return Contextly.SnippetWidgetFormatterFactory.getInstance().getFormatter(this.widget)}});Contextly.SidebarWidget=Contextly.createClass({extend:Contextly.Widget,getWidgetFormatter:function(){return Contextly.SidebarWidgetFormatterFactory.getInstance().getFormatter(this.widget)}});Contextly.AutoSidebarWidget=Contextly.createClass({extend:Contextly.Widget,getWidgetFormatter:function(){return Contextly.SidebarWidgetFormatterFactory.getInstance().getFormatter(this.widget)}});Contextly.SnippetWidgetFormatterFactory=Contextly.createClass({extend:Contextly.Singleton,getFormatter:function(e){var t=e.settings.display_type;if(t=="default")return new Contextly.SnippetWidgetTextFormatter(e);if(t=="tabs")return new Contextly.SnippetWidgetTabsFormatter(e);if(t=="blocks")return new Contextly.SnippetWidgetBlocksFormatter(e);if(t=="blocks2")return new Contextly.SnippetWidgetBlocks2Formatter(e);if(t=="float")return new Contextly.SnippetWidgetFloatFormatter(e)}});Contextly.SidebarWidgetFormatterFactory=Contextly.createClass({extend:Contextly.Singleton,getFormatter:function(e){return new Contextly.SidebarWidgetFormatter(e)}});Contextly.SnippetWidgetFormatter=Contextly.createClass({abstracts:["getWidgetHTML","getWidgetCssName"],construct:function(e){this.widget=e;this.widget_type=Contextly.WidgetType.SNIPPET;this.widget_html_id="ctx_linker"},getDisplayElement:function(){return jQuery("#"+this.widget_html_id)},hasWidgetData:function(){return this.widget&&this.widget.links},displayText:function(e){this.getDisplayElement().html(e)},appendText:function(e){this.getDisplayElement().append(e)},displayAdminControls:function(){var e="";if(this.hasWidgetData()){e="<br><input type='button' class='button action' value='Edit Related Posts' onclick='Contextly.PopupHelper.getInstance().snippetPopup();' />";this.appendText(e)}else{e="<input type='button' class='button action' value='Choose Related Posts' onclick='Contextly.PopupHelper.getInstance().snippetPopup();' />";this.displayText(e)}},isDisplaySection:function(e){var t=jQuery.inArray(e,this.widget.settings.display_sections)!=-1,n=this.widget.links&&this.widget.links[e]&&this.widget.links[e].length>0;return t&&n},display:function(){if(this.hasWidgetData()){this.displayText(this.getWidgetHTML());this.loadCss();this.attachVideoPopups();Contextly.Settings.getInstance().isAdmin()||this.fixSnippetPagePosition();var e=this.getSettings();e&&e.display_type&&this.getDisplayElement().attr("widget-type",e.display_type)}Contextly.Settings.getInstance().isAdmin()&&this.displayAdminControls();this.setResponsiveFunction()},attachVideoPopups:function(){jQuery("a[rel='ctx_video_link']").each(function(){jQuery(this).prettyPhoto({animation_speed:"fast",slideshow:1e4,hideflash:!0});jQuery(this).click(function(){var e=jQuery(this).attr("contextly-url");Contextly.MainServerAjaxClient.getInstance().call(e)})})},loadCss:function(){var e=this.getWidgetCSSUrl();Contextly.Utils.getInstance().loadCssFile(e);if(Contextly.Utils.getInstance().isIE7()){var t=Contextly.Settings.getInstance().getCdnCssUrl()+"_plugin/"+Contextly.Settings.getInstance().getPluginVersion()+"/css/template-ie-fix.css";Contextly.Utils.getInstance().loadCssFile(t)}var n=this.getCustomCssCode();n&&Contextly.Utils.getInstance().loadCustomCssCode(n,this.getWidgetType()+"-custom")},getWidgetCSSUrl:function(){var e,t=this.getSettings();Contextly.Settings.getInstance().getMode()=="local"?e="http://linker.site/resources/css/plugin/widget/"+t.display_type+"/template-"+t.tabs_style+".css":Contextly.Settings.getInstance().getMode()=="dev"?e="http://dev.contextly.com/resources/css/plugin/widget/"+t.display_type+"/template-"+t.tabs_style+".css":e=Contextly.Settings.getInstance().getCdnCssUrl()+"_plugin/"+Contextly.Settings.getInstance().getPluginVersion()+"/css-api/widget/"+t.display_type+"/template-"+t.tabs_style+".css";return e},getCustomCssCode:function(){return Contextly.CssCustomBuilder.getInstance().buildCSS(".ctx_widget",this.getSettings())},fixSnippetPagePosition:function(){this.getDisplayElement().is(":last-child")||this.getDisplayElement().parent().append(this.getDisplayElement());var e=Contextly.Settings.getInstance().getWPSettings();typeof e!="undefined"&&typeof e.target_id!="undefined"&&e.target_id&&(typeof e.block_position!="undefined"&&e.block_position=="before"?this.getDisplayElement().insertBefore(jQuery("#"+e.target_id)):e.target_id&&this.getDisplayElement().insertAfter(jQuery("#"+e.target_id)))},getImageDimension:function(){return this.getImageDimensionFor(this.getSettings().images_type)},getImageDimensionFor:function(e){e=e.replace("square","").replace("letter","");var t=e.split("x"),n=0,r=0;if(t.length==2){n=parseInt(t[0]);r=parseInt(t[1])}return{width:n,height:r}},getImagesHeight:function(){var e=this.getImageDimension();return e.height},getImagesWidth:function(){var e=this.getImageDimension();return e.width},getWidget:function(){return this.widget},getWidgetType:function(){return this.widget_type},getSettings:function(){return this.getWidget().settings},getWidgetLinks:function(){return this.getWidget()&&this.getWidget().links?this.getWidget().links:null},getWidgetSectionLinks:function(e){var t=this.getWidgetLinks();return t&&t[e]?t[e]:null},getLinkThumbnailUrl:function(e){return e.thumbnail_url?e.thumbnail_url:null},getWidgetCssName:function(){return"default-widget"},escape:function(e){return Contextly.Utils.getInstance().escape(e)},getOnclickHtml:function(e){var t=this.getSettings();return t&&t.utm_enable?' onclick="'+this.getTrackLinkJSHtml(e)+'"':""},getLinkATag:function(e,t){return'<a class="ctx_title ctx_module" href="'+this.escape(e.native_url)+'" title="'+this.escape(e.title)+'" onmousedown="this.href=\''+this.escape(e.url)+"'\" "+this.getOnclickHtml(e)+">"+t+"</a>"+this.getLinkATagIE7Fix()},getVideoLinkATag:function(e,t){return'<a class="ctx_title ctx_module" rel="ctx_video_link" href="'+this.escape(e.native_url)+'" title="'+this.escape(e.title)+'" contextly-url="'+e.url+'" '+"'\" "+this.getOnclickHtml(e)+">"+t+"</a>"+this.getLinkATagIE7Fix()},getTrackLinkJSHtml:function(e){var t=this.escape(this.getWidgetType()),n=this.escape(e.type),r=this.escape(e.title);return this.escape("Contextly.PageEvents.getInstance().trackLink('"+t+"','"+n+"','"+r+"');")},getLinkATagIE7Fix:function(){return"<!--[if lte ie 7]><b></b><![endif]-->"},getLinkHTML:function(e){return e.video?this.getLinkHTMLVideo(e):this.getLinkHTMLNormal(e)},getInnerLinkHTML:function(e){return e.title},getLinkHTMLVideo:function(e){return"<li>"+this.getVideoLinkATag(e,this.getInnerLinkHTML(e))+"</li>"},getLinkHTMLNormal:function(e){return"<li>"+this.getLinkATag(e,this.getInnerLinkHTML(e))+"</li>"},getBrandingHtml:function(){var e="<a href='#ctx_branding_content' id='ctx_branding_open' class=\"ctx_pluginauthor ctx_modal_open\"><span>Powered by</span></a>";e+='<div id=\'ctx_branding_content\' style="display:none;margin:1em;"><div id="ctx_modal" class="ctx_well">';e+="<div id='ctx_popupcontainer'>";e+="<span id=\"ctx_poplogo\"></span><span id='ctx_popupperbg'></span><div id='ctx_poptext'>";e+="Contextly recommends interesting and related stories using a unique combination of algorithms and editorial choices.<br><br>";e+="Publishers or advertisers who would like to learn more about Contextly can contact us&nbsp;";e+='<a href="http://contextly.com/sign-up/publishers/" target="_blank">here</a>.<br><br>';e+="We respect ";e+='<a href="http://contextly.com/privacy/" target="_blank">readers\' privacy </a>.&nbsp;';e+="</div></div>";e+="<span id='ctx_popsymbol'></span>";e+="</div></div>";return e},isDisplayContextlyLogo:function(){return Contextly.Settings.getInstance().isDisplayBranding()},setResponsiveFunction:function(){function e(){function e(){return jQuery(".ctx_widget")}function t(){return e().attr("widget-type")}function n(){return"ontouchstart"in window}function r(){var e=jQuery(window).width();return e}function i(){var t=jQuery(e()).width();return t}function s(){MinLimit=480;return MinLimit}function o(e){var t="ctx_around_site "+e;jQuery(".ctx_around_site").attr("class",t)}function u(e){var t="ctx_see_also ctx_text_widget "+e;jQuery(".ctx_see_also").attr("class",t)}function a(e){var t="ctx_widget_hidden ctx_sidebar ctx_sidebar_left "+e;jQuery(".ctx_sidebar_left").attr("class",t)}if(r()>605){var f=552;cxt_popup_height=292}else{var f=250;cxt_popup_height=500}jQuery("#ctx_branding_open").prettyPhoto({theme:"light_square",autoplay_slideshow:!1,default_width:f,default_height:cxt_popup_height,social_tools:!1,show_title:!1});t()=="blocks2"&&(i()<s()?o("ctx_blocks2mobile"):o("ctx_blocks2site"));t()=="float"&&(i()<s()?o("ctx_floatmobile"):i()<550&&i()>s()?o("ctx_floattablet"):o("ctx_floatsite"));if(t()=="blocks"){i()<500?o("ctx_blockmobile"):o("ctx_blocksite");if(n()||r()<800)jQuery(".ctx_blocks_widget li a p").css("height","auto");else{jQuery(".ctx_blocks_widget li a").on("mouseover",function(e){jQuery(this).toggleClass("ctx_blocksslider");var t=jQuery(".ctx_blocksslider p span").height();t>50&&jQuery(".ctx_blocksslider p").css("height",t)});jQuery(".ctx_blocks_widget li a").on("mouseout",function(e){jQuery(".ctx_blocksslider p").css("height","46px");jQuery(this).removeClass("ctx_blocksslider")})}}t()=="default"&&(i()<520?u("ctx_textmobile"):u("ctx_textsite"));var l=jQuery(".ctx_sidebar_link").width();l<256?a("ctx_sidebarmobile"):a("ctx_sidebarsite")}function t(){i++;e();n();i>10&&n()}function n(){r&&clearInterval(r)}jQuery(window).resize(function(){e()});var r=null,i=0;jQuery(document).ready(function(){r=self.setInterval(function(){t()},500)})}});Contextly.CssCustomBuilder=Contextly.createClass({extend:Contextly.Singleton,buildCSSRule:function(e,t,n,r){return r?e+" "+t+" {"+n+": "+Contextly.Utils.getInstance().escape(r)+"}":""},hex2Vals:function(e){e.charAt(0)=="#"&&(e=e.slice(1));e=e.toUpperCase();var t="0123456789ABCDEF",n=new Array(3),r=0,i,s;for(var o=0;o<6;o+=2){i=t.indexOf(e.charAt(o));s=t.indexOf(e.charAt(o+1));n[r]=i*16+s;r++}return n}});Contextly.SnippetWidgetTextFormatter=Contextly.createClass({extend:Contextly.SnippetWidgetFormatter,getWidgetCssName:function(){return"ctx_text_widget"},getWidgetHTML:function(){var e="";e+="<div class='ctx_see_also "+this.getWidgetCssName()+"'>";var t=this.widget.settings.display_sections;for(var n in t){var r=t[n];if(this.isDisplaySection(r)){var i=r+"_subhead",s=this.widget.settings[i];e+="<div class='ctx_previous'>";e+="<div class='ctx_subhead'><span class='ctx_subhead_title'>"+this.escape(s)+"</span></div>";e+="<ul class='ctx_link'>"+this.getLinksHTMLOfType(r)+"</ul>";e+="</div>"}}e+="</div>";this.isDisplayContextlyLogo()&&(e+="<div class='ctx_branding'>"+this.getBrandingHtml()+"</div>");return e},getLinksHTMLOfType:function(e){var t="",n=this.widget;if(n.links&&n.links[e])for(var r in n.links[e]){var i=n.links[e][r];i.id&&i.title&&(t+=this.getLinkHTML(i))}return t},getCustomCssCode:function(){return Contextly.TextWidgetCssCustomBuilder.getInstance().buildCSS(".ctx_widget",this.getSettings())}});Contextly.TextWidgetCssCustomBuilder=Contextly.createClass({extend:[Contextly.CssCustomBuilder,Contextly.Singleton],buildCSS:function(e,t){var n="";t.css_code&&(n+=".ctx_text_widget "+Contextly.Utils.getInstance().escape(t.css_code));t.font_family&&(n+=this.buildCSSRule(e,".ctx_text_widget .ctx_link","font-family",t.font_family));t.font_size&&(n+=this.buildCSSRule(e,".ctx_text_widget .ctx_link","font-size",t.font_size));t.color_links&&(n+=this.buildCSSRule(e,".ctx_text_widget a.ctx_title","color",t.color_links));t.color_background&&(n+=this.buildCSSRule(e,".ctx_text_widget .ctx_subhead","background-color",t.color_background));return n}});Contextly.SnippetWidgetTabsFormatter=Contextly.createClass({extend:Contextly.SnippetWidgetFormatter,getTabsWidget:function(){return jQuery(".ctx_widget")},getWidgetCssName:function(){return"ctx_tabs_widget"},getWidgetWidth:function(){return this.getTabsWidget().width()},WidgetIsChromeBlocks:function(){var e=this.getWidgetWidth();return e<400&&e>0?!0:!1},getWidgetHTML:function(){var e="<div class='ctx_see_also "+this.getWidgetCssName()+"'>",t=this.widget.settings.display_sections;e+='<ul class="ctx_tabs">';if(this.WidgetIsChromeBlocks()==1){this.getTabsWidget().removeClass("ctx_tabs_site");this.getTabsWidget().addClass("ctx_tabs_block");for(var n in t){var r=t[n];if(this.isDisplaySection(r)){var i=r+"_subhead",s=this.widget.settings[i];e+="<li id='ctx_linker_tab_"+r+"'>";e+="<span style='width: 100%'>"+this.escape(s)+"</span>";e+="<div id='ctx_linker_content_"+r+"' class='ctx_content'  style='display: block;'>"+"<ul class='ctx_link "+(this.hasImagesForLinks(r)?"linker_images":"ctx_chrome_noimages")+" '>"+this.getLinksHTMLOfType(r)+"</ul>"+"</div>";e+="</li>"}}e+="</ul>"}else{this.getTabsWidget().removeClass("ctx_tabs_block");this.getTabsWidget().addClass("ctx_tabs_site");var o=!1;for(var n in t){var r=t[n];if(this.isDisplaySection(r)){var i=r+"_subhead",s=this.widget.settings[i];e+="<li id='ctx_linker_tab_"+r+"' "+(o?"":"class='active'")+">";e+="<a href='javascript:;' onclick='Contextly.PageEvents.getInstance().switchTab(\""+this.widget.settings.id+'", "'+r+"\")'><span>"+this.escape(s)+"</span></a>";e+="</li>";o=!0}}e+="</ul>";o=!1;for(var n in t){var r=t[n];if(this.isDisplaySection(r)){e+="<div id='ctx_linker_content_"+r+"' class='ctx_content' "+(o?"":"style='display: block;'")+">"+"<ul class='ctx_link "+(this.hasImagesForLinks(r)?"linker_images":"ctx_chrome_noimages")+" '>"+this.getLinksHTMLOfType(r)+"</ul>"+"</div>";o=!0}}}this.isDisplayContextlyLogo()&&(e+="<div class='ctx_branding'>"+this.getBrandingHtml()+"</div>");e+="</div>";return e},getLinksHTMLOfType:function(e){var t="",n=this.getWidgetSectionLinks(e);if(n){for(var r=0;r<n.length;r++){var i=n[r];if(i.id&&i.title){t+="<li "+(parseInt(r)+1>this.widget.settings.links_limit?"class='li"+e+"'":"")+">";t+=this.getLinkHTML(i);t+="</li>"}}n.length>this.widget.settings.links_limit&&(t+='<p class="show-more" id="pmore'+e+'"><a href="javascript:;"  onclick="Contextly.PageEvents.getInstance().showMore(\''+this.widget.settings.id+"', '"+e+'\');" name="amore'+e+'">Show More</a></p>')}return t},getLinkHTML:function(e){var t="";e.thumbnail_url&&(this.WidgetIsChromeBlocks()==1?t+="style='height: 70px'":t+="style='height: "+this.getImagesHeight()+"px'");var n="<ul class='ctx_horizontal_line' "+t+">";if(e.thumbnail_url){if(this.WidgetIsChromeBlocks()==1)var r=70;else var r=this.getImagesWidth();var i=r+8,s="<img src='"+e.thumbnail_url+"' style='width: "+r+"px !important;' />",o;e.video?o=this.getVideoLinkATag(e,s):o=this.getLinkATag(e,s);n+="<li style='width: "+i+"px;'>"+o+"</li>"}e.video?n+="<li>"+this.getVideoLinkATag(e,e.title)+"</a>":n+="<li>"+this.getLinkATag(e,e.title)+"</a>";this.widget.settings.display_link_dates&&e.publish_date&&(n+=" <span class='link-pub-date'>"+Contextly.Utils.getInstance().dateTextDiff(e.publish_date)+"</span>");n+=this.getLinkATagIE7Fix()+"</li>";n+="</ul>";return n},hasImagesForLinks:function(e){var t=0;for(var n in this.widget.links[e])this.widget.links[e][n].thumbnail_url&&t++;if(this.widget.links[e].length==t)return!0},getCustomCssCode:function(){return Contextly.TabsWidgetCssCustomBuilder.getInstance().buildCSS(".ctx_widget",this.getSettings())}});Contextly.TabsWidgetCssCustomBuilder=Contextly.createClass({extend:[Contextly.CssCustomBuilder,Contextly.Singleton],buildCSS:function(e,t){var n="";t.css_code&&(n+=".ctx_tabs_widget "+Contextly.Utils.getInstance().escape(t.css_code));t.font_family&&(n+=this.buildCSSRule(e,".ctx_tabs_widget .ctx_link","font-family",t.font_family));t.font_size&&(n+=this.buildCSSRule(e,".ctx_tabs_widget .ctx_link","font-size",t.font_size));if(t.color_background){n+=this.buildCSSRule(e,".ctx_tabs_widget .ctx_content","background-color",t.color_background);n+=this.buildCSSRule(e,".ctx_tabs_widget .ctx_images img","border-color",t.color_background)}if(t.color_links){n+=this.buildCSSRule(e,".ctx_tabs_widget .ctx_content li a","color",t.color_links);n+=this.buildCSSRule(e,".ctx_tabs_widget .ctx_content span","color",t.color_links)}if(t.color_border){n+=this.buildCSSRule(e,".ctx_tabs_widget .ctx_content","border-color",t.color_border);n+=this.buildCSSRule(e,".ctx_tabs_widget .ctx_tabs li.active span","border-color",t.color_border);n+=this.buildCSSRule(e,".ctx_tabs_widget .ctx_tabs span","border-color",t.color_border)}t.color_active_tab&&(n+=this.buildCSSRule(e,".ctx_tabs_widget .ctx_tabs li.active span","background",t.color_active_tab));t.color_inactive_tab&&(n+=this.buildCSSRule(e,".ctx_tabs_widget .ctx_tabs span","background",t.color_inactive_tab));return n}});Contextly.SnippetWidgetBlocksFormatter=Contextly.createClass({extend:Contextly.SnippetWidgetTextFormatter,getNumberOfLinksPerSection:function(){return 4},getLinksHTMLOfType:function(e){var t="",n=this.widget,r=this.getNumberOfLinksPerSection();if(n.links&&n.links[e])for(var i in n.links[e]){if(i>=r)break;var s=n.links[e][i];s.id&&s.title&&(t+=this.getLinkHTML(s))}return t},getWidgetCssName:function(){return"ctx_blocks_widget"},getWidgetHTML:function(){var e="";e+="<div class='ctx_see_also "+this.getWidgetCssName()+"'>";var t=this.widget.settings.display_sections;e+="<div class='ctx_around_site'>";for(var n in t){var r=t[n];if(this.isDisplaySection(r)){var i=r+"_subhead",s=this.widget.settings[i];e+="<div class='ctx_previous'>";e+="<div class='ctx_subhead'><span class='ctx_subhead_title'>"+this.escape(s)+"</span></div>";e+="<ul class='ctx_link'>"+this.getLinksHTMLOfType(r)+"</ul>";e+="</div>"}}e+="</div>";this.isDisplayContextlyLogo()&&(e+="<div class='ctx_branding'>"+this.getBrandingHtml()+"</div>");return e},getLinkHTML:function(e){return e.video?this.getLinkHTMLVideo(e):this.getLinkHTMLNormal(e)},getInnerLinkHTML:function(e){var t="<p class='ctx_link'><span>"+e.title+"</span></p>";this.getLinkThumbnailUrl(e)&&(t+="<img src='"+e.thumbnail_url+"' />");return t},getLinkHTMLVideo:function(e){return"<li>"+this.getVideoLinkATag(e,this.getInnerLinkHTML(e))+"</li>"},getLinkHTMLNormal:function(e){return"<li>"+this.getLinkATag(e,this.getInnerLinkHTML(e))+"</li>"},getCustomCssCode:function(){return Contextly.BlocksWidgetCssCustomBuilder.getInstance().buildCSS(".ctx_widget",this.getSettings())}});Contextly.BlocksWidgetCssCustomBuilder=Contextly.createClass({extend:[Contextly.CssCustomBuilder,Contextly.Singleton],buildCSS:function(e,t){var n="";t.css_code&&(n+=".ctx_blocks_widget "+Contextly.Utils.getInstance().escape(t.css_code));t.font_family&&(n+=this.buildCSSRule(e,".ctx_blocks_widget p.ctx_link","font-family",t.font_family));t.font_size&&(n+=this.buildCSSRule(e,".ctx_blocks_widget p.ctx_link","font-size",t.font_size));t.color_links&&(n+=this.buildCSSRule(e,".ctx_blocks_widget .ctx_link span","color",t.color_links));t.color_background&&(n+=this.buildCSSRule(e,".ctx_blocks_widget .ctx_subhead","background-color",t.color_background));if(t.color_border){var r=t.color_border,i=this.hex2Vals(r);if(i.length==3){var s=i[0],o=i[1],u=i[2];n+=this.buildCSSRule(e,".ctx_blocks_widget li p","background","rgba("+s+","+o+","+u+",0.5)")}}return n}});Contextly.SnippetWidgetBlocks2Formatter=Contextly.createClass({extend:Contextly.SnippetWidgetBlocksFormatter,getWidgetCssName:function(){return"ctx_blocks_widget2"},getInnerLinkHTML:function(e,t){var n="";if(this.getLinkThumbnailUrl(e)){t&&(n+="<div class='playbutton-wrapper'>");n+="<img src='"+e.thumbnail_url+"' />";t&&(n+="</div>")}n+="<p class='ctx_link'><span>"+e.title+"</span></p>";return n},getLinkHTMLVideo:function(e){return"<li>"+this.getVideoLinkATag(e,this.getInnerLinkHTML(e,!0))+"</li>"},getCustomCssCode:function(){return Contextly.Blocks2WidgetCssCustomBuilder.getInstance().buildCSS(".ctx_widget",this.getSettings())}});Contextly.Blocks2WidgetCssCustomBuilder=Contextly.createClass({extend:[Contextly.CssCustomBuilder,Contextly.Singleton],buildCSS:function(e,t){var n="";t.css_code&&(n+=".ctx_blocks2_widget "+Contextly.Utils.getInstance().escape(t.css_code));t.font_family&&(n+=this.buildCSSRule(e,".ctx_blocks_widget2 p.ctx_link","font-family",t.font_family));t.font_size&&(n+=this.buildCSSRule(e,".ctx_blocks_widget2 p.ctx_link","font-size",t.font_size));t.color_links&&(n+=this.buildCSSRule(e,".ctx_blocks_widget2 .ctx_link span","color",t.color_links));t.color_background&&(n+=this.buildCSSRule(e,".ctx_blocks_widget2 .ctx_subhead","background-color",t.color_background));return n}});Contextly.SnippetWidgetFloatFormatter=Contextly.createClass({extend:Contextly.SnippetWidgetBlocksFormatter,getWidgetCssName:function(){return"ctx_float_widget"},getNumberOfLinksPerSection:function(){return this.getSettings().links_limit},getInnerLinkHTML:function(e,t){var n="";if(this.getLinkThumbnailUrl(e)){t&&(n+="<div class='playbutton-wrapper'>");n+="<img src='"+e.thumbnail_url+"' />";t&&(n+="</div>")}var r=this.getImagesWidth()+10;n+="<p class='ctx_link' style='width: "+r+"px;'><span>"+e.title+"</span></p>";return n},getLinkHTMLVideo:function(e){return"<li>"+this.getVideoLinkATag(e,this.getInnerLinkHTML(e,!0))+"</li>"},getCustomCssCode:function(){return Contextly.FloatWidgetCssCustomBuilder.getInstance().buildCSS(".ctx_widget",this.getSettings())}});Contextly.FloatWidgetCssCustomBuilder=Contextly.createClass({extend:[Contextly.CssCustomBuilder,Contextly.Singleton],buildCSS:function(e,t){var n="";t.css_code&&(n+=".ctx_float_widget "+Contextly.Utils.getInstance().escape(t.css_code));t.font_family&&(n+=this.buildCSSRule(e,".ctx_float_widget .ctx_link","font-family",t.font_family));t.font_size&&(n+=this.buildCSSRule(e,".ctx_float_widget .ctx_link","font-size",t.font_size));t.color_links&&(n+=this.buildCSSRule(e,".ctx_float_widget .ctx_link span","color",t.color_links));t.color_background&&(n+=this.buildCSSRule(e,".ctx_float_widget .ctx_subhead","background-color",t.color_background));return n}});Contextly.SidebarWidgetFormatter=Contextly.createClass({extend:Contextly.SnippetWidgetTabsFormatter,construct:function(e){if(e){this.widget=e;this.widget_type=Contextly.WidgetType.SIDEBAR;this.widget_html_id="contextly-"+e.id}},getWidgetHTML:function(){return"<div class='ctx_content'><ul class='ctx_sidebar_link "+(this.hasImagesForLinks("previous")?"ctx_images":"ctx_noimages")+"'>"+this.getLinksHTMLOfType("previous")+"</ul></div>"},getLinksHTMLOfType:function(e){var t="";if(this.widget&&this.widget.links&&this.widget.links[e])for(var n in this.widget.links[e]){var r=this.widget.links[e][n];r.id&&r.title&&(t+="<li>"+this.getLinkHTML(r)+"</li>")}return t},display:function(){var e=this;jQuery(document).ready(function(){if(e.hasWidgetData()&&!Contextly.Settings.getInstance().isAdmin()){var t=e.getWidgetHTML();e.displayText(t);e.getDisplayElement().removeClass("ctx_sidebar_hidden").addClass("ctx_sidebar").addClass("ctx_sidebar_"+e.widget.layout);var n=e.widget.name,r=e.widget.description,i=e.getDisplayElement().find(".ctx_content");r&&i.prepend("<div class='ctx_sidebar_description'>"+e.escape(r)+"</div>");n&&i.prepend("<div class='ctx_sidebar_title'>"+e.escape(n)+"</div>");e.loadCss()}})},getWidgetCSSUrl:function(){var e,t=this.getSettings();Contextly.Settings.getInstance().getMode()=="local"?e="http://linker.site/resources/css/plugin/sidebar/template-"+t.theme+".css":Contextly.Settings.getInstance().getMode()=="dev"?e="http://dev.contextly.com/resources/css/plugin/sidebar/template-"+t.theme+".css":e=Contextly.Settings.getInstance().getCdnCssUrl()+"_plugin/"+Contextly.Settings.getInstance().getPluginVersion()+"/css-api/sidebar/template-"+t.theme+".css";return e},getCustomCssCode:function(){return Contextly.SidebarWidgetCssCustomBuilder.getInstance().buildCSS(".ctx_sidebar",this.getSettings())}});Contextly.SidebarWidgetCssCustomBuilder=Contextly.createClass({extend:[Contextly.CssCustomBuilder,Contextly.Singleton],buildCSS:function(e,t){var n="";if(t.css_code){var r=Contextly.Utils.getInstance().escape(t.css_code);r.indexOf(e)==-1&&(r+=e+r);n+=r}if(t.font_family){n+=this.buildCSSRule(e,"a.ctx_title","font-family",t.font_family);n+=this.buildCSSRule(e,".ctx_sidebar_title","font-family",t.font_family);n+=this.buildCSSRule(e,".ctx_sidebar_description","font-family",t.font_family)}t.font_size&&(n+=this.buildCSSRule(e,"a.ctx_title","font-size",t.font_size));if(t.color_background){n+=this.buildCSSRule(e,".ctx_content","background-color",t.color_background);n+=this.buildCSSRule(e,".ctx_images img","border-color",t.color_background)}if(t.color_links){n+=this.buildCSSRule(e,".ctx_content .ctx_title","color",t.color_links);n+=this.buildCSSRule(e,".ctx_content span","color",t.color_links)}t.color_border&&(n+=this.buildCSSRule(e,".ctx_content","border-color",t.color_border+" !important;"));t.title_font_size&&(n+=this.buildCSSRule(e,".ctx_sidebar_title","font-size",t.title_font_size));t.description_font_size&&(n+=this.buildCSSRule(e,".ctx_sidebar_description","font-size",t.description_font_size));return n}});Contextly.Utils=Contextly.createClass({extend:Contextly.Singleton,dateTextDiff:function(e){if(e&&e.length>4){var t=e.split(/[- :]/),n=new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5]),r=n.getTime()/1e3,i=(new Date).getTime()/1e3-r,s=new Array("sec","min","hour","day","week","month","year","decade"),o=new Array("60","60","24","7","4.35","12","10"),u;if(i>0){u="ago";for(var a=0;i>=o[a];a++)i/=o[a];i=Math.round(i);i!=1&&(s[a]+="s");return i+"&nbsp;"+s[a]+"&nbsp;"+u}return"right now"}},stringToDate:function(e){var t=e.split(" ")[0].split("-"),n=e.split(" ")[1].split(":"),r=new Date(t[0],t[1],t[2]);r.setHours(n[0],n[1],n[2]);return r},isPostNeedsToBeUpdated:function(e,t){if(e!=t){var n=Contextly.Utils.getInstance().stringToDate(t),r=(new Date).getTime(),i=Math.abs((r-n)/1e3),s=94608e3;if(i<=s)return!0}return!1},isIE7:function(){return navigator.userAgent.match(/MSIE ([0-9]+)\./)&&RegExp.$1<8?!0:!1},loadCssFile:function(e){jQuery("head").append("<link>");var t=jQuery("head").children(":last");t.attr({rel:"stylesheet",media:"screen",type:"text/css",href:e})},loadCustomCssCode:function(e,t){t&&jQuery('style[contextly_id="'+t+'"]').remove();jQuery("head").append(jQuery("<style type='text/css' contextly_id='"+t+"'>"+e+"</style>"))},escape:function(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}});Contextly.PageEvents=Contextly.createClass({extend:Contextly.Singleton,switchTab:function(e,t){jQuery("#ctx_linker_content_previous,#ctx_linker_content_web,#ctx_linker_content_interesting,#ctx_linker_content_custom").hide();jQuery("#ctx_linker_tab_previous,#ctx_linker_tab_web,#ctx_linker_tab_interesting,#ctx_linker_tab_custom").attr("class","");jQuery("#ctx_linker_content_"+t).show();jQuery("#ctx_linker_tab_"+t).attr("class","active");Contextly.Loader.getInstance().trackPageEvent(e,"switch_tab",t)},showMore:function(e,t){jQuery(".li"+t).toggleClass("show");var n=jQuery("#pmore"+t);n.toggleClass("show");n.hasClass("show")?n.find("a").text("Show Fewer"):n.find("a").text("Show More");Contextly.Loader.getInstance().trackPageEvent(e,"show_more",t)},trackLink:function(e,t,n){var r=null;if(!e||!t||!n)return;typeof _gaq!="undefined"?r=_gaq:typeof gts!="undefined"&&(r=gts);if(r!=null){var i=30,s="ContextlyWidget",o="ClickedOutBound",u=n;e==Contextly.WidgetType.SIDEBAR&&(s="ContextlySidebar");u.length>i&&(u=u.substr(0,i));e!=Contextly.WidgetType.SIDEBAR||t!=Contextly.LinkType.WEB&&t!=Contextly.LinkType.PREVIOUS?t==Contextly.LinkType.PREVIOUS?o="ClickedPreviousRelated":t==Contextly.LinkType.RECENT?o="ClickedRecentRelated":t==Contextly.LinkType.PROMO?o="ClickedPromoLink":o="Clicked"+t.charAt(0).toUpperCase()+t.slice(1):o="ClickedRecentRelated";r.push(["_trackEvent",s,o,u])}}});Contextly.Settings=Contextly.createClass({extend:Contextly.Singleton,getAPIServerUrl:function(){return Contextly.api_server},getMainServerUrl:function(){return Contextly.main_server},getPopupServerUrl
:function(){return Contextly.popup_server},getPluginVersion:function(){return Contextly.version},getAppId:function(){return Contextly.app_id},isAdmin:function(){return Contextly.admin},getPageId:function(){return Contextly.post.post_id},getMode:function(){return Contextly.mode},getPostModifiedDate:function(){return Contextly.post.post_modified},getPostCreatedDate:function(){return Contextly.post.post_date},getAuthorId:function(){return Contextly.post.author},getWPSettings:function(){return Contextly.settings},isHttps:function(){return Contextly.https},getCdnCssUrl:function(){return this.isHttps()?"https://c713421.ssl.cf2.rackcdn.com/":"http://contextlysiteimages.contextly.com/"},isReadyToLoad:function(){return Contextly.disable_autoload&&Contextly.disable_autoload==1?!1:!0},getAjaxUrl:function(){return Contextly.ajax_url},getAjaxNonce:function(){return Contextly.ajax_nonce?Contextly.ajax_nonce:null},isDisplayBranding:function(){return!this.isAdmin()}});Contextly.RESTClient=Contextly.createClass({extend:Contextly.Singleton,getApiRPC:function(){if(!this.api_rpc){var e=Contextly.Settings.getInstance().getAPIServerUrl()+"/easy_xdm/cors/index.html";this.api_rpc=new easyXDM.Rpc({remote:e},{remote:{request:{}}})}return this.api_rpc},call:function(e,t,n,r){var i=Contextly.Settings.getInstance(),s=i.getAPIServerUrl()+e+"/"+t+"/";n=jQuery.extend(n,{version:i.getPluginVersion(),site_path:i.getAppId(),admin:i.isAdmin(),page_id:i.getPageId()});var o=this;this.getApiRPC().request({url:s,method:"POST",data:n},function(e){o.restCallback(e,r)})},restCallback:function(e,t){if(!e.data)return;var n=easyXDM.getJSONObject().parse(e.data);this.restDebug(n);t(n)},restDebug:function(e){if(e.q){e.t&&console.log("Time: "+e.t);e.m&&console.log("Memory: "+e.m);for(var t in e.q)console.log(e.q[t])}}});Contextly.MainServerAjaxClient=Contextly.createClass({extend:Contextly.Singleton,getXhr:function(){if(!this.xhr){var e=Contextly.Settings.getInstance().getMainServerUrl()+"/easy_xdm/cors/index.html";e=e.replace("https://","http://");this.xhr=new easyXDM.Rpc({remote:e},{remote:{request:{}}})}return this.xhr},call:function(e,t){this.getXhr().request({url:e,method:"POST"},function(e){t&&t(e)})}});Contextly.PopupHelper=Contextly.createClass({extend:Contextly.Singleton,construct:function(){this.popup_socket=null},initWithWidget:function(e){this.widget=e;this.snippet=null;if(e&&e.snippets&&e.snippets.length){var t=e.snippets[0];t.id&&(this.snippet=t)}},initWithUrl:function(e){this.url=e},snippetPopup:function(){if(this.url||!this.widget){this.showStubPopup();return}var e=Contextly.Settings.getInstance(),t=e.getPopupServerUrl()+"sites/"+e.getAppId()+"/"+"?page_id="+e.getPageId()+"&author="+e.getAuthorId()+"&edit_snippet_id="+(this.snippet?this.snippet.id:"");this.openPopupWithCallback(t,function(e){Contextly.Loader.getInstance().load()})},sidebarPopup:function(e){if(this.url||!this.widget){this.showStubPopup();return}var t=Contextly.Settings.getInstance(),n=t.getPopupServerUrl()+"sites/"+t.getAppId()+"/sidebar/"+"?page_id="+t.getPageId()+"&sidebar_id="+(e?e:"");this.openPopupWithCallback(n,function(e){if(e.status=="ok"&&e.snippet_id){var t=e.data;t.entry&&t.entry.type==Contextly.WidgetType.AUTO_SIDEBAR?send_to_editor('[contextly_auto_sidebar id="'+e.snippet_id+'"]'):send_to_editor('[contextly_sidebar id="'+e.snippet_id+'"]');Contextly.Loader.getInstance().load()}})},linkPopup:function(){if(this.url||!this.widget){this.showStubPopup();return}var e=Contextly.Settings.getInstance(),t=e.getPopupServerUrl()+"sites/"+e.getAppId()+"/"+"?page_id="+e.getPageId()+"&edit_snippet_id="+(this.snippet?this.snippet.id:"")+"&tinymce_link_text="+tinymce.plugins.ContextlyPluginLink.getSelectedText();this.openPopupWithCallback(t,function(e){if(e.status=="ok"){Contextly.Loader.getInstance().load();tinymce.activeEditor.plugins.contextlylink.insertLink(e.link_url,e.link_title)}})},openPopupWithCallback:function(e,t){window.open(e+"#easyXDM_linker_channel_provider","contextlyapp","width=1150,height=600,resizable=1,scrollbars=1,menubar=1");if(t){this.popup_socket!=null&&this.popup_socket.destroy();this.popup_socket=new easyXDM.Socket({channel:"linker_channel",remote:Contextly.Settings.getInstance().getPopupServerUrl()+"/resources/html/remote.html",onMessage:function(e,n){if(e){var r=easyXDM.getJSONObject().parse(e);t(r)}}})}},showStubPopup:function(){this.url=this.url||"http://contextly.com/contact-us/";window.open(this.url)},showPublishConfirmation:function(){var e="contextly_publish_confirmation",t="contextly_add_related_links_btn",n="contextly_publish_now_btn",r=420,i=150,s="Publish confirmation",o=jQuery("#publish").attr("value"),u="Choose Related Posts";jQuery(".button-primary").removeClass("button-primary-disabled");jQuery("span.spinner").hide();jQuery("body").append(jQuery('<div id="'+e+'" style="display:none;">'+"<div style='float:left; padding:10px;'>This post doesn't have any chosen links to other posts. Would you like to do that now?<br /><br /> If you want to add a sidebar, close this window, put the cursor where you'd like the sidebar to be and click the sidebar button.</div>"+'<input id="contextly_add_related_links_btn" type="button" value="'+u+'" class="button button-primary" />'+'<input id="contextly_publish_now_btn" type="button" value="'+o+'" class="button" style="margin-left: 20px; float: right;" />'+"</div>"));jQuery("#"+t).click(function(){tb_remove();Contextly.PopupHelper.getInstance().snippetPopup()});jQuery("#"+n).click(function(){tb_remove();jQuery("#publish").unbind("click");jQuery("#publish").click()});tb_show(s,"#TB_inline?height="+i+"&amp;width="+r+"&amp;inlineId="+e);jQuery("#TB_window").width(r+30);jQuery("#TB_window").height(i+20)}});Contextly.SettingsAutoLogin=Contextly.createClass({extend:Contextly.Singleton,doLogin:function(){var e="#contextly-settings-btn";jQuery(e).attr("disabled","disabled");jQuery.ajax({url:Contextly.Settings.getInstance().getAjaxUrl(),type:"post",dataType:"json",data:{action:"contextly_get_auth_token"},success:function(t){t.success&&t.contextly_access_token&&jQuery(e).attr("contextly_access_token",t.contextly_access_token);jQuery(e).removeAttr("disabled")},error:function(){jQuery(e).removeAttr("disabled")}})}});Contextly.Loader.getInstance().load();